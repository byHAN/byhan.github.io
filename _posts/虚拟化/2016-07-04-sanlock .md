---
layout: post
title: sanlock
category: 技术
tags: 虚拟化层
keywords: 
description: 
---

## 一句话介绍 ##

## 安装 ##

## Fedora/RHEL ##

    su - root
    # yum install libvirt-lock-sanlock
    
## 配置 ##

#### 启动狗 #### 

     $ su - root
     # chkconfig wdmd on
     # service wdmd start

#### 启动sanlock ####

    # chkconfig sanlock on
    # service sanlock start

#### 配置qemu-sanlock.conf ####

host_id需要时1-2000之间的值，需要计算节点各不相同  

     $ su - root
     # augtool -s set /files/etc/libvirt/qemu-sanlock.conf/host_id 1

需要配置这两项（把这两项放开）  
![](http://i.imgur.com/ihqpvrG.png)  

#### 配置存储 ####

sanlock需要创建租约文件，租约文件存储需要计算节点都可以访问的共享存储  
可以是NFS或者是GFS2，这里使用nfs  
上面我们配置了disk_lease_dir为/var/lib/libvirt/sanlock  
那么更新节点上的/etc/fstab来mount一个共享存储到上述路径  

    # echo "some.nfs.server:/export/sanlock /var/lib/libvirt/sanlock nfs hard,nointr 0 0" >> /etc/fstab
    # mount /var/lib/libvirt/sanlock

some.nfs.server:/export/sanlock是提前搭建好的nfs服务器  
执行完，df -h可以看挂载结果  

#### 配置qemu.conf ####

如果进程启动不是root而是sanlock需要更新/etc/libvirt/qemu.conf  

    augtool -s set /files/etc/libvirt/qemu-sanlock.conf/user sanlock
    augtool -s set /files/etc/libvirt/qemu-sanlock.conf/group sanlock

设置lock_manager为sanlock
    augtool -s  set /files/etc/libvirt/qemu.conf/lock_manager sanlock
    # service libvirtd restart

配置完毕，可通过如下方式简单验证  

     # ls /var/lib/libvirt/sanlock/
     __LIBVIRT__DISKS__
    

## 功能验证 ##

创建一个虚拟机磁盘  

    # qemu-img create  /home/disk.img 100M
    
创建虚拟机xml  

    <domain type='qemu'>
    <name>demo1</name>
    <memory>219200</memory>
    <vcpu>1</vcpu>
    <os>
    <type arch='x86_64'>hvm</type>
    <boot dev='cdrom'/>
    </os>
    <devices>
    <disk type='file' device='disk'>
    <driver name='qemu' type='raw'/>
    <source file='/home/disk.img'/>
    <target dev='vda' bus='virtio'/>
    </disk>
    </devices>
    </domain> 

创建虚拟机  

    virsh create vm.xml

查看虚拟机  

    virsh list  

查看租约文件，可以看到在目录下增加了租约文件  
![](http://i.imgur.com/0yscppG.png)  

然后把虚拟机的xml名字修改为demo2,再次创建虚拟机  

![](http://i.imgur.com/8NOqb4W.png)  
可见锁生效，创建虚拟机失败  

### ceph ###
sudo mount -t ceph 10.10.200.208:6789:/ /mnt/mycephfs -o name=neutron_cinder,secret=AQB4CB5XKK2nCRAAAXsP/0IF7x3+9v3OTvYG5w==















![](http://i.imgur.com/yApH1Jm.png)

## libvirt ##

![](http://i.imgur.com/0wAcROf.png)  

在运行libvirtd的时候,我们需要获得lbivirtd的运行信息。  
所以我们需要找到他的日志文件。  
一般情况下,它是在/var/log/libvirt/libvirtd.log路径下。  
可能在这个目录下没有发现这个的日志文件.那么就要配置一些libvitd的参数了
    #将日志级别设置为 1（调试）
    log_level = 1
    #指定日志输出文件名称
    log_outputs="1:file:/var/log/libvirt/libvirtd.log"








## 问题记录 ##
- ceph场景下如何配置
- ubuntu场景下如何编译


## storage pool ##
https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/6/html/Virtualization_Administration_Guide/create-lvm-storage-pool-virsh.html

http://www.ibm.com/developerworks/cn/linux/l-cn-libvirt-lvm/

## ubuntu ##

libvirt-sanlock在ubuntu没有可以直接安装的包，sanlock功能无法直接使用。  
需要另外重新编译libvirt包，将sanlock功能编译进去。  
具体可以参考如下：  

1.  配置好源，/etc/apt/source.list使用ubuntu官方源即可，需要src的源下载源码包： 
  
    deb http://cn.archive.ubuntu.com/ubuntu/ trusty main restricted
    deb-src http://cn.archive.ubuntu.com/ubuntu/ trusty main restricted
    deb http://cn.archive.ubuntu.com/ubuntu/ trusty-updates main restricted
    deb-src http://cn.archive.ubuntu.com/ubuntu/ trusty-updates main restricted
    deb http://cn.archive.ubuntu.com/ubuntu/ trusty universe
    deb-src http://cn.archive.ubuntu.com/ubuntu/ trusty universe
    deb http://cn.archive.ubuntu.com/ubuntu/ trusty-updates universe
    deb-src http://cn.archive.ubuntu.com/ubuntu/ trusty-updates universe
  
2.  更新apt源并安装build工具  

    sudo apt-get update
    sudo apt-get upgrade
    sudo apt-get install build-essential devscripts

3.  获取源码包并安装build的依赖包：  
    
    apt-get source libvirt
    sudo apt-get build-dep libvirt
    sudo apt-get install libsanlock-dev
    
4.  更改source文件配置  
cd libvirt-1.2.2/debian  
(1)先从rules文件开始  
vim rules  
添加“--with-sanlock \” 至DEB_CONFIGURE_EXTRA_FLAGS变量下并保存文件  
(2)然后 修改control文件  
vim control  
添加“libsanlock-dev,” 至Build-Depends列表下. (在“# For make check”前添加即可.)  
添加“libsanlock-client1,”至package libvirt-bin下的Depends列表下，保存  

5.  回上一层目录并更新changelog：  

    cd ..
    dch -i

6.  编译libvirt包  

    debuild -us -uc -b

7.  若一切正常在上一层目录会生成5个deb的安装包：  
    （这里本人包依赖有冲突，包编译失败，以下来自参考文档）  
    ![](http://i.imgur.com/edynQDg.png)  

    ../libvirt-bin_1.2.2-0ubuntu13.1.18_amd64.deb  
    ../libvirt-doc_1.2.2-0ubuntu13.1.18_all.deb  
    ../libvirt0_1.2.2-0ubuntu13.1.18_amd64.deb  
    ../libvirt-dev_1.2.2-0ubuntu13.1.18_amd64.deb  
    ../libvirt0-dbg_1.2.2-0ubuntu13.1.18_amd64.deb  

## 参考文献 ##

[http://manpages.ubuntu.com/manpages/trusty/man8/sanlock.8.html](http://manpages.ubuntu.com/manpages/trusty/man8/sanlock.8.html)  
[http://www.th7.cn/system/lin/201603/157030.shtml](http://www.th7.cn/system/lin/201603/157030.shtml)